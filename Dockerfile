# Dockerfile
FROM debian:bookworm-slim

# Install required packages
RUN apt-get update && apt-get install -y \
	bind9 \
	apache2 \
	supervisor \
	git \
	python3-requests

# Copy Apache2 websites and config
ARG PAYLOAD_HOST
SHELL ["/bin/bash", "-c"]
COPY ./apache2/html /var/www/html/
RUN if [[ ! -z ${PAYLOAD_HOST} ]]; then rm -rf /var/www/html/manuals && git clone ${CUSTOM_PAYLOAD_HOST} /var/www/html/manuals ; fi
COPY ./apache2/sites-enabled /etc/apache2/sites-enabled/

# Enable required Apache2 modules
RUN a2enmod headers rewrite ssl

# Generate fake SSL certificates
RUN openssl req -nodes -x509 -newkey rsa:4096 -keyout /etc/apache2/fakessl.key -out /etc/apache2/fakessl.crt -days 36500 -subj '/CN=*/CN=*.*/CN=*.*.*/CN=*.*.*.*/CN=*.*.*.*.*/CN=*.*.*.*.*.*/CN=*.*.*.*.*.*.*/CN=*.*.*.*.*.*.*.*' > /dev/null 2>&1
RUN chmod 644 /etc/apache2/fakessl.crt
RUN chmod 640 /etc/apache2/fakessl.key

# Setup bind log dir
RUN mkdir -m 750 /var/log/bind && chown bind:bind /var/log/bind

# Clone BIND config repo to /etc/bind and set correct permissions
RUN git clone https://github.com/jeroendev-one/bind-ps-config /tmp/startupconfig
RUN mv /tmp/startupconfig/* /etc/bind
RUN chown -R bind:bind /etc/bind

# Copy the supervisord configuration
RUN mkdir -p /var/run/supervisor
COPY ./supervisor /etc/supervisor
RUN chmod 755 /etc/supervisor/github_check.py

# Expose the intended ports
EXPOSE 53/udp 80/tcp 443/tcp

# Start supervisord
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/supervisord.conf"]
