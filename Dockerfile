# Dockerfile
FROM debian:bookworm-slim

# Install required packages
RUN apt-get update && apt-get install -y bind9 apache2 supervisor

# Copy Apache2 websites and config
COPY ./apache2/html /var/www/html/
COPY ./apache2/sites-enabled /etc/apache2/sites-enabled/

# Enable required Apache2 modules
RUN a2enmod headers rewrite ssl

# Generate fake SSL certificates
RUN openssl req -nodes -x509 -newkey rsa:4096 -keyout /etc/apache2/fakessl.key -out /etc/apache2/fakessl.crt -days 36500 -subj '/CN=*/CN=*.*/CN=*.*.*/CN=*.*.*.*/CN=*.*.*.*.*/CN=*.*.*.*.*.*/CN=*.*.*.*.*.*.*/CN=*.*.*.*.*.*.*.*' > /dev/null 2>&1
RUN chmod 644 /etc/apache2/fakessl.crt
RUN chmod 640 /etc/apache2/fakessl.key

# Setup bind log dir
RUN mkdir -m 750 /var/log/bind && chown bind:bind /var/log/bind

# Copy BIND config directory to /etc/bind and set correct permissions
COPY ./bind /etc/bind/
RUN chown -R bind:bind /etc/bind

# Copy the supervisord configuration
COPY ./supervisor /etc/supervisor

# Expose the intended ports
EXPOSE 53/udp 80/tcp 443/tcp

# Start supervisord
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/supervisord.conf"]
