#!/usr/bin/env python3

import datetime
import requests
import subprocess
import time
import shutil

# GitHub repository details
github_repo = 'jeroendev-one/bind-ps-config'
github_api_url = f'https://api.github.com/repos/{github_repo}/commits'

# Directory BIND configuration files are stored
bind_config_dir = '/etc/bind'

# Interval for the check
check_interval = 600  # 1 hour

# The last known commit SHA
last_commit_sha = None

while True:
    try:
        response = requests.get(github_api_url)
        response.raise_for_status()
        commit_sha = response.json()[0]['sha']

        if last_commit_sha is None:
            last_commit_sha = commit_sha
        elif last_commit_sha != commit_sha:
            timestamp = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            message = f"{timestamp} - GitHub repository has been updated. Reloading BIND and copying new config."
            print(message)
            subprocess.run(['rndc', 'reload'])
            last_commit_sha = commit_sha

            # Copy the updated configuration from the repository
            shutil.rmtree(bind_config_dir)
            subprocess.run(['git', 'clone', f'https://github.com/{github_repo}.git', bind_config_dir])

        else:
            timestamp = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            message = f"{timestamp} - No updates in the GitHub repository."
            print(message)

    except Exception as e:
        timestamp = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        message = f"{timestamp} - Error: {e}"
        print(message)

    time.sleep(check_interval)

